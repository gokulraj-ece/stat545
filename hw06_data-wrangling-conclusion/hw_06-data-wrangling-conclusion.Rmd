---
title: "Data Wrangling Conclusion"
author: "Gokul Raj Suresh Kumar"
date: "`r format(Sys.Date())`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Data Wrangling Conclusion

####Loading the required packages

```{r warning=FALSE, message=FALSE}
library(gapminder)
library(tidyverse)
library(ggplot2)
library(MASS)
library(broom)
```


##Writing Functions

```{r dev='CairoPNG'}
selected_country <- "China"

( selected_country_info <- gapminder %>% 
    filter( country == selected_country ) )

p <- selected_country_info %>% 
  ggplot( aes( x = year , y = lifeExp ) )

p + geom_point( ) + 
  geom_smooth( method = "lm" , aes( colour = "lm" ) , lwd = 0.5 , se = FALSE ) + 
  geom_smooth( method = "rlm" , aes( colour = "rlm" ) , lwd = 0.5 , se = FALSE ) +
  geom_smooth( method = "lm" , formula = y ~ x + I( x^2 ) , lwd = 0.5 , se = FALSE )
  
# linear
linear_fit <- lm( lifeExp ~ I( year - 1952 ) , data = selected_country_info )

coef( linear_fit )

le_linear_fit <- function( data , offset = 1952 ){
  linear_fit <- lm( lifeExp ~ I( year - offset ) , data = data )
  setNames( coef( linear_fit ) , c( "intercept" , "slope" ) )
}

le_linear_fit( selected_country_info )

# robust 
robust_fit <- rlm( lifeExp ~ I( year - 1952 ) , data = selected_country_info )

coef( robust_fit )

le_robust_fit <- function( data , offset = 1952 ) {
  robust_fit <- rlm( lifeExp ~ I( year - offset ) , data = data )
  setNames( coef( robust_fit ) , c( "intercept" , "slope" ) )
}

le_robust_fit( selected_country_info )

# quadratic
quadratic_fit <- lm( lifeExp ~ I( year - 1952 ) + I( ( year - 1952 )^2 ) , data = selected_country_info )

coef( quadratic_fit )

le_quadratic_fit <- function( data , offset = 1952 ){
  quadratic_fit <- lm( lifeExp ~ I( year - offset ) + I( ( year - offset )^2 ) , data = data )
  setNames( coef( quadratic_fit ) , c( "intercept" , "slope 1" , "slope 2" ) )
}

le_quadratic_fit( selected_country_info )
``` 

##Working with a nested data frame

```{r warning=FALSE,dev='CairoPNG'}
( nested_gap <- gapminder %>% 
    group_by( continent , country ) %>% 
    nest( ) )

# linear
le_linear_fit( nested_gap$data[[25]] )

le_linear_res <- map( nested_gap$data[1:2] , le_linear_fit )

le_lin_fit_all <- nested_gap %>% 
  mutate( linear_fit = map( data , le_linear_fit ) )

le_lin_fit_all$linear_fit[[25]]

tidy( le_lin_fit_all$linear_fit[[25]] )

le_lin_fit_all <- le_lin_fit_all %>% 
  mutate( tidy = map( linear_fit , tidy ) )

le_lin_fit_all$tidy[[25]]

le_lin_coefs <- le_lin_fit_all %>% 
  dplyr::select( continent , country , tidy ) %>% 
  unnest( tidy )

le_lin_ests <- le_lin_coefs %>% 
  dplyr::select( continent:x ) %>% 
  spread( key = "names" , value = "x" )

knitr::kable( le_lin_ests %>% head( ) )

le_lin_fit_broom <- gapminder %>% 
  group_by( continent , country ) %>% 
  do( fit = lm( lifeExp ~ I( year - 1952 ) , . ) )

le_lin_fit_broom %>% 
  tidy( fit )

# robust
le_robust_fit( nested_gap$data[[25]] )

le_robust_res <- map( nested_gap$data[1:2] , le_robust_fit )

le_rob_fit_all <- nested_gap %>% 
  mutate( robust_fit = map( data , le_robust_fit ) )

le_rob_fit_all$robust_fit[[25]]

le_rob_fit_all <- le_rob_fit_all %>% 
  mutate( tidy = map( robust_fit , tidy ) )

le_rob_fit_all$tidy[[25]]

le_rob_coefs <- le_rob_fit_all %>% 
  dplyr::select( continent , country , tidy ) %>% 
  unnest( tidy )

le_rob_ests <- le_rob_coefs %>% 
  dplyr::select( continent:x ) %>% 
  spread( key = "names" , value = "x" )

knitr::kable( le_rob_ests %>% head( ) )

le_rob_fit_broom <- gapminder %>% 
  group_by( continent , country ) %>% 
  do( fit = rlm( lifeExp ~ I( year - 1952 ) , . ) )

le_rob_fit_broom %>% 
  tidy( fit )

#quadratic
le_quadratic_fit( nested_gap$data[[25]] )

le_quad_res <- map( nested_gap$data[1:2] , le_quadratic_fit )

le_quad_fit_all <- nested_gap %>% 
  mutate( quadratic_fit = map( data , le_quadratic_fit ) )

le_quad_fit_all$quadratic_fit[[25]]

le_quad_fit_all <- le_quad_fit_all %>% 
  mutate( tidy = map( quadratic_fit , tidy ) )

le_quad_fit_all$tidy[[25]]

le_quad_coefs <- le_quad_fit_all %>% 
  dplyr::select( continent , country , tidy ) %>% 
  unnest( tidy )

le_quad_ests <- le_quad_coefs %>% 
  dplyr::select( continent:x ) %>% 
  spread( key = "names" , value = "x" ) 

knitr::kable( le_quad_ests %>% head( ) )

le_quad_fit_broom <- gapminder %>% 
  group_by( continent , country ) %>% 
  do( fit = rlm( lifeExp ~ I( year - 1952 ) + I( ( year - 1952 )^2 ) , . ) )

le_quad_fit_broom %>% 
  tidy( fit )

#linear and robust comparison

le_lin_rob_est <- left_join( le_lin_ests , le_rob_ests , by = c( "continent", "country" ) )

le_lin_rob_est <- le_lin_rob_est %>% 
  mutate( slope_diff = (slope.x - slope.y ) , intercept_diff = (intercept.x - intercept.y ) ) %>%  
  dplyr::select( country , slope_diff , intercept_diff )

knitr::kable( le_lin_rob_est %>% head( ) )

ggplot( le_lin_rob_est , aes( x = intercept_diff , y = slope_diff ) ) + geom_point( )

le_lin_rob_est %>% filter( ( intercept_diff < -1 ) | ( slope_diff < -0.075 ) )

interesting_countries <- 
  c( "Mauritius" , "Cambodia" , "Bulgaria" , "Lesotho" , "Rwanda" , "South Africa" , "Swaziland" )  

( interesting_countries_info <- gapminder %>% 
    filter( country %in% interesting_countries ) )

p <- interesting_countries_info %>% 
  ggplot( aes( x = year , y = lifeExp ) )

p + geom_point( ) + 
  facet_wrap( ~ country ) + 
  geom_smooth( method = "lm" , lwd = 0.5 , aes( colour = "lm" ) , se = FALSE ) + 
  geom_smooth( method = "rlm" , lwd = 0.5 , aes( colour = "rlm" ) , se = FALSE )


```


http://www.alastairsanderson.com/R/tutorials/robust-regression-in-R

http://statistics.ats.ucla.edu/stat/r/faq/smooths.htm

http://www.theanalysisfactor.com/r-tutorial-4/

http://www.stat.yale.edu/Courses/1997-98/101/linreg.htm



