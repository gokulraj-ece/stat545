---
title: "Factor and Figure Management"
author: "Gokul Raj Suresh Kumar"
date: "`r format(Sys.Date())`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Factor and Figure Management

####Loading the required packages

```{r message=FALSE}
library(gapminder)
library(tidyverse)
library(forcats)
```

##Factor Management

###Dropping Oceania

####Gapminder's details

```{r}
gapminder %>% 
  count( continent )
nrow( gapminder )
nlevels( gapminder$continent )
nlevels( gapminder$country )
```

####Oceania's details (for manual validation)

```{r}
just_oceania <- gapminder %>%
  filter( continent == "Oceania" ) %>%
  droplevels()
just_oceania %>%
  count( continent )
nrow( just_oceania )
nlevels( just_oceania$continent )
nlevels( just_oceania$country )
```

####Details after dropping Oceania

```{r}
# Dropping Oceania and it's factor levels
(without_oceania <- gapminder %>%
  filter( continent != "Oceania" ) %>%
  droplevels())
# The tibble shows that Oceania has been removed
without_oceania %>%
  count( continent )
# 1704 - 24 (Observations for all continents - Observations for Oceania)
nrow( without_oceania )
# 5 - 1 (All continents - Oceania)
nlevels( without_oceania$continent )
# 142 - 2 (All countries - (New Zealand + Australia))
nlevels( without_oceania$country )
```

###Reordering the levels of `country`

####Extracting maximum population of Countries in Europe (between 1952 and 2007)

```{r}
max_pop_europe <- gapminder %>%
  filter( continent == "Europe" ) %>%
  group_by( country ) %>% 
  summarize( max_pop = max( pop ) ) %>%
  droplevels() %>%
  ungroup()
  
head( max_pop_europe )

nrow( max_pop_europe )

max_pop_europe$country %>%
  levels() %>%
  head()
```

####Reordering factor levels of European countries based on descending order of maximum population

```{r}
head( levels( max_pop_europe$country ) )

pop_reorder_europe <- max_pop_europe %>% 
  mutate( country = fct_reorder( country , max_pop , .desc = TRUE ) )

head( levels( pop_reorder_europe$country ) )

head( pop_reorder_europe )
```

####Exploring the effects of `arrange()`

```{r}
pop_arr_europe <- max_pop_europe %>%
  arrange( desc( max_pop ) ) 

head(pop_arr_europe)

pop_arr_europe$country %>% 
  levels() %>% 
  head()

pop_arr_europe %>%
  ggplot( aes( x = max_pop , y = country ) ) + geom_point()
```

####Exploring the effects of reordering a factor( without `arrange()`)

```{r}
pop_reorder_europe$country %>%
  levels() %>%
  head()

p <- pop_reorder_europe %>% 
  ggplot( aes( x = max_pop , y = country ) ) + geom_point()

p
```

####Exploring the effects of factor reordering with `arrange()`

```{r}
head(pop_arr_europe)

pop_arr_europe %>% 
  ggplot( aes( x = max_pop, y = fct_reorder( country , max_pop , .desc = TRUE ) ) ) + geom_point()
```

##File I/O

###Data to be used for experimentation

```{r}
head( pop_reorder_europe )

head( levels( pop_reorder_europe$country ) )
```

###Writing to (`write_csv()`) and reading from (`read_csv()`) a comma-delimited file 

```{r}
write_csv( pop_reorder_europe , "pop_reorder_europe.csv" )

eur_csv_data <- read_csv( "pop_reorder_europe.csv" )

head( eur_csv_data )

head( levels( eur_csv_data$country ) )
```

###Writing to (`saveRDS()`) and reading from (`readRDS()`) a file while preserving factor levels

```{r}
saveRDS( pop_reorder_europe , "pop_reorder_europe.rds" )

eur_rds_data <- readRDS( "pop_reorder_europe.rds" )

head( eur_rds_data )

head( levels( eur_rds_data$country ) )
```

###Writing to (`dput()`) and reading from (`dget()`) a file while preserving factor levels

```{r}
dput( pop_reorder_europe , "pop_reorder_europe-dput.txt" )

eur_txt_data <- dget( "pop_reorder_europe-dput.txt" )

head( eur_txt_data )

head( levels( eur_txt_data$country ) )
```

##Visualization design

###Code to generate the number of countries having relative life expectancy < India

```{r}
my_gap <- gapminder

benchmark_country <- my_gap %>% 
  filter( country == "India" )

rel_le <- my_gap %>% 
  mutate( temp = rep( benchmark_country$lifeExp , nlevels( country ) ), 
          lifeExpRel = lifeExp/temp, 
          temp = NULL )

rel_abundance <- rel_le %>%
  group_by( continent , year ) %>% 
  filter( lifeExpRel < 1 ) %>% 
  summarise( n_countries = n_distinct( country ) )
```

###Oops! I have used a stacked barplot in assignment 3

```{r dev='CairoPNG'}
rel_abundance %>%
  ggplot( aes( x = year , y = n_countries , fill = continent ) ) + 
  geom_bar( stat = "identity" , position = "stack" ) +
  labs( title = "No. of Countries having lifeExp < India" , x = "Year" , y = "Number of Countries" )
```

###Partitioning the above into small multiple bar charts (One chart per continent)

```{r dev='CairoPNG', fig.width=8, fig.height=6}
q <- rel_abundance %>% 
  ggplot( aes( x = year , y = n_countries ) ) + 
  geom_bar( width = 1 , stat = "identity" ) + 
  facet_wrap( ~continent , nrow = 3 ) + 
  labs( title = "No. of Countries having lifeExp < India" , x = "Year" , y = "Number of Countries" )

q
```

##Writing figures to a file

###Using `ggsave()` to write a figure to a file Explicitly

```{r}
ggsave( "max_pop_europe.png" , plot = p )
```



###Changing size of the plot to be saved using the `width=` and `height=` argument to `ggsave()`

```{r}
ggsave( "resized_max_pop_europe.png" , plot = p , height = 10 , width = 10 )
```



###Scenario where explicit provision of the plot object matters

```{r}
ggsave( "rel_lifeExp_lt_India.png" )
```



```{r}
ggsave( "rel_lifeExp_lt_India_for_sure.png" , plot = q )
```



